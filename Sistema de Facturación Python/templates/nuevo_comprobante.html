<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Comprobante</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">

    <style>
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .total-summary {
            margin-top: 20px;
        }
        .total-summary td {
            padding: 8px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<div class="container mt-4">    
    <h1>Nuevo Comprobante</h1>
    <form action="{{ url_for('nuevo_comprobante') }}" method="post">
        <div class="mb-3">
            <label for="cliente" class="form-label">
                <i class="material-icons">person</i>Cliente
            </label>
            <!-- Parte del código para seleccionar clientes -->
            <select class="form-select" id="cliente" name="cliente" onchange="updateRUC(this.value)">
                <option selected>Seleccione un Cliente</option>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.NOMBRE }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="ruc" class="form-label"><i class="material-icons">assignment_ind</i>RUC</label>
                </select>
            </div>
            <div class="mb-3">
            <input type="text" class="form-control" id="ruc" name="ruc" readonly>
        </div>
        <div class="mb-3">
            <label for="serie" class="form-label">
                <i class="material-icons">receipt</i>Código del Comprobante</label>
            <input type="text" class="form-control" id="serie" name="serie" value="{{ siguiente_numero }}" readonly>
        </div>
        
        <div class="mb-3">
            <label for="fecha_emision" class="form-label">
                <i class="material-icons">event</i>Fecha de Emisión</label>
            <input type="date" class="form-control" id="fecha_emision" name="fecha_emision" required>
        </div>
        <div id="items">
            <!-- Items will be added here -->
        </div>
        <button type="button" class="btn btn-secondary" onclick="agregarItem()">
            <i class="material-icons">add</i>Agregar Item</button>
        <div class="total-summary">
            <table class="table">
                <tbody>
                    <tr>
                        <td>Total Afecto:</td>
                        <td class="text-end">S/<span id="totalAfecto">0.00</span></td>
                    </tr>
                    <tr>
                        <td>IGV (18%):</td>
                        <td class="text-end">S/<span id="totalIGV">0.00</span></td>
                    </tr>
                    <tr>
                        <td><strong>TOTAL:</strong></td>
                        <td class="text-end"><strong>S/<span id="totalGeneral">0.00</span></strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button type="submit" class="btn btn-primary"><i class="material-icons">save</i>Guardar</button>
    </form>
</div>

<script>

let itemIndex = 0;

function fetchProductDetails(productId, index) {
    fetch(`/get_producto/${productId}`)
        .then(response => response.json())
        .then(data => {
            // Asegurarse de que el campo de precio unitario se actualiza correctamente
            document.querySelector(`input[name='items[${index}][precio_unitario]']`).value = data.precio;
            calculateTotal(index);
        })
        .catch(error => {
            console.error('Error al recuperar el precio:', error);
            // En caso de error, poner precio en 0
            document.querySelector(`input[name='items[${index}][precio_unitario]']`).value = "0";
        });
}



function agregarItem() {
    const itemsContainer = document.getElementById('items');
    const newItem = document.createElement('div');
    newItem.classList.add('input-group');

    // Generar un ID único para cada descripción de datalist
    const descriptionId = `descriptions-${itemIndex}`;

    newItem.innerHTML = `
        <input type="number" name="items[${itemIndex}][cantidad]" class="form-control" placeholder="Cantidad" onchange="calculateTotal(${itemIndex})" required>
        <input list="${descriptionId}" name="items[${itemIndex}][descripcion]" class="form-control" placeholder="Descripción" onchange="updateProductDetails(this, ${itemIndex})" required>
        <datalist id="${descriptionId}">
            {% for producto in productos %}
            <option data-product-id="{{ producto.id }}" value="{{ producto.descripcion }}"></option>
            {% endfor %}
        </datalist>
        <input type="hidden" name="items[${itemIndex}][codigo_item]" class="form-control" required>
        <input type="text" name="items[${itemIndex}][precio_unitario]" class="form-control" placeholder="P. Unit." readonly>
        <input type="text" name="items[${itemIndex}][total]" class="form-control" placeholder="Total" readonly>
        <button class="btn btn-danger" type="button" onclick="removeItem(this)">Eliminar</button>
    `;
    itemsContainer.appendChild(newItem);
    itemIndex++;
}

function updateProductDetails(inputElement, index) {
    const datalist = document.getElementById(inputElement.getAttribute('list'));
    const option = datalist.querySelector(`option[value="${inputElement.value}"]`);
    const productId = option.getAttribute('data-product-id');

    // Actualizar el campo oculto con el ID del producto seleccionado
    const codigoItemInput = document.querySelector(`input[name='items[${index}][codigo_item]']`);
    codigoItemInput.value = productId;

    // Actualizar el precio del producto utilizando una función que deberías tener similar a `fetchProductDetails`
    fetchProductDetails(productId, index);
}



function removeItem(button) {
    button.parentElement.remove();
    updateTotals();
}

function calculateTotal(index) {
    const cantidad = parseFloat(document.querySelector(`input[name='items[${index}][cantidad]']`).value) || 0;
    const precio = parseFloat(document.querySelector(`input[name='items[${index}][precio_unitario]']`).value) || 0;
    const total = cantidad * precio;
    document.querySelector(`input[name='items[${index}][total]']`).value = total.toFixed(2);
    updateTotals();
}

function updateTotals() {
    let totalAfecto = 0;
    document.querySelectorAll(`input[name*='[total]']`).forEach(input => {
        totalAfecto += parseFloat(input.value);
    });
    const igv = totalAfecto * 18/118;
    const totalGeneral = totalAfecto - igv;
    document.getElementById('totalAfecto').textContent = totalGeneral.toFixed(2);
    document.getElementById('totalIGV').textContent = igv.toFixed(2);
    document.getElementById('totalGeneral').textContent = totalAfecto.toFixed(2);
}

function updateRUC(clienteId) {
    // Actualizar el RUC basado en la selección del cliente
    document.getElementById('ruc').value = clienteId; // Simulación, reemplazar con datos reales
}
</script>

</body>
</html>
