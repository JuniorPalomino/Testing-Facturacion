<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Nuevo Comprobante</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="/static/style.css">
    
        <style>
            .input-group {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }
            .total-summary {
                margin-top: 20px;
            }
            .total-summary td {
                padding: 8px;
                font-size: 16px;
            }
                /* Estilos para el modal */
            .modal {
                display: none; /* Por defecto, el modal estará oculto */
                position: fixed;
                z-index: 1;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.4); /* Fondo oscuro */
            }

            .modal-content {
                background-color: #fefefe;
                margin: 15% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
            }

            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }

            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }
        </style>
        
    </head>
    <body>
    <div class="container mt-4">    
        <h1>Nuevo Comprobante</h1>
        <form action="{{ url_for('nuevo_comprobante') }}" method="post">
            <div class="mb-3">
                <label for="cliente" class="form-label">
                    <i class="material-icons">person</i>Cliente
                </label>
                <!-- Parte del código para seleccionar clientes -->
                <select class="form-select" id="cliente" name="cliente" onchange="updateRUC(this.value)">
                    <option selected>Seleccione un Cliente</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id }}">{{ cliente.NOMBRE }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="ruc" class="form-label"><i class="material-icons">assignment_ind</i>RUC</label>
                    </select>
                </div>
                <div class="mb-3">
                <input type="text" class="form-control" id="ruc" name="ruc" readonly>
            </div>
            <div class="mb-3">
                <label for="serie" class="form-label">
                    <i class="material-icons">receipt</i>Código del Comprobante</label>
                <input type="text" class="form-control" id="serie" name="serie" value="{{ siguiente_numero }}" readonly>
            </div>
            
            <div class="mb-3">
                <label for="fecha_emision" class="form-label">
                    <i class="material-icons">event</i>Fecha de Emisión</label>
                <input type="date" class="form-control" id="fecha_emision" name="fecha_emision" required>
            </div>
            <div id="items">
                <!-- Items will be added here -->
            </div>
            <button type="button" class="btn btn-secondary" onclick="agregarItem()">
                <i class="material-icons">add</i>Agregar Item</button>
            <div class="total-summary">
                <table class="table">
                    <tbody>
                        <tr>
                            <td>Total Afecto:</td>
                            <td class="text-end">S/<span id="totalAfecto">0.00</span></td>
                        </tr>
                        <tr>
                            <td>IGV (18%):</td>
                            <td class="text-end">S/<span id="totalIGV">0.00</span></td>
                        </tr>
                        <tr>
                            <td><strong>TOTAL:</strong></td>
                            <td class="text-end"><strong>S/<span id="totalGeneral">0.00</span></strong></td>
                        </tr>
                        <input type="hidden" id="totalAfectoInput" name="totalAfecto" value="0.00">
                        <input type="hidden" id="totalIGVInput" name="totalIGV" value="0.00">
                        <input type="hidden" id="totalGeneralInput" name="totalGeneral" value="0.00">
                    </tbody>
                </table>
            </div>
            <button type="submit" class="btn btn-primary" onclick="enviarFormulario()"><i class="material-icons">save</i>Guardar</button>
            <div id="myModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <p id="error-message"></p>
                </div>
            </div>
        </form>
    </div>
    


<script>

// Obtener el modal
var modal = document.getElementById("myModal");

// Obtener el botón para cerrar el modal
var span = document.getElementsByClassName("close")[0];

// Cuando el usuario haga clic en el botón de cerrar (x), cerrar el modal
span.onclick = function() {
    modal.style.display = "none";
}

// Cuando el usuario haga clic en cualquier lugar fuera del modal, cerrar el modal
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

// Función para mostrar el modal con un mensaje de error
function mostrarError(mensaje) {
    document.getElementById("error-message").innerText = mensaje;
    modal.style.display = "block";
}

document.addEventListener('DOMContentLoaded', function() {
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0!
    var yyyy = today.getFullYear();

    today = yyyy + '-' + mm + '-' + dd;
    var minDate = new Date(today);
    minDate.setDate(minDate.getDate() - 7);
    var maxDate = new Date(today);
    maxDate.setDate(maxDate.getDate() + 7);

    var minDateString = minDate.toISOString().split('T')[0];
    var maxDateString = maxDate.toISOString().split('T')[0];

    var inputFechaEmision = document.getElementById('fecha_emision');
    inputFechaEmision.setAttribute('min', minDateString);
    inputFechaEmision.setAttribute('max', maxDateString);
});

let itemIndex = 0;

function fetchProductDetails(productId, index) {
    fetch(`/get_producto/${productId}`)
        .then(response => response.json())
        .then(data => {
            // Asegurarse de que el campo de precio unitario se actualiza correctamente
            document.querySelector(`input[name='items[${index}][precio_unitario]']`).value = data.precio;
            calculateTotal(index);
        })
        .catch(error => {
            console.error('Error al recuperar el precio:', error);
            // En caso de error, poner precio en 0
            document.querySelector(`input[name='items[${index}][precio_unitario]']`).value = "0";
        });
}


function agregarItem() {
    const itemsContainer = document.getElementById('items');
    const newItem = document.createElement('div');
    newItem.classList.add('input-group');

    // Generar un ID único para cada descripción de datalist
    const descriptionId = `descriptions-${itemIndex}`;

    newItem.innerHTML = `
        <input type="number" name="items[${itemIndex}][cantidad]" class="form-control" placeholder="Cantidad" min="1"onchange="calculateTotal(${itemIndex})" required>
        <input list="${descriptionId}" name="items[${itemIndex}][descripcion]" class="form-control" placeholder="Descripción" onchange="updateProductDetails(this, ${itemIndex})" required>
        <datalist id="${descriptionId}">
            {% for producto in productos %}
            <option data-product-id="{{ producto.id }}" value="{{ producto.descripcion }}"></option>
            {% endfor %}
        </datalist>
        <input type="hidden" name="items[${itemIndex}][codigo_item]" class="form-control" required>
        <input type="text" name="items[${itemIndex}][precio_unitario]" class="form-control" placeholder="P. Unit." readonly>
        <input type="text" name="items[${itemIndex}][total]" class="form-control" placeholder="Total" readonly>
        <button class="btn btn-danger" type="button" onclick="removeItem(this)">Eliminar</button>
    `;
    itemsContainer.appendChild(newItem);
    itemIndex++;
}
// Función para obtener todos los datos de los elementos dentro del contenedor "items"
function obtenerDatosItems() {
    const itemsContainer = document.getElementById('items');
    const items = itemsContainer.querySelectorAll('.input-group');

    const datosItems = [];

    items.forEach(item => {
        const cantidad = item.querySelector('input[name^="items["][name$="[cantidad]"]').value;
        const descripcion = item.querySelector('input[name^="items["][name$="[descripcion]"]').value;
        const codigoItem = item.querySelector('input[name^="items["][name$="[codigo_item]"]').value;
        const precioUnitario = item.querySelector('input[name^="items["][name$="[precio_unitario]"]').value;
        const total = item.querySelector('input[name^="items["][name$="[total]"]').value;

        const datosItem = {
            cantidad: cantidad,
            descripcion: descripcion,
            codigo_item: codigoItem,
            precio_unitario: precioUnitario,
            total: total
        };

        datosItems.push(datosItem);
    });

    return datosItems;
}

// Función para manejar el envío del formulario
function enviarFormulario() {
    // Obtener los datos de los elementos dentro del contenedor "items"
    const datosItems = obtenerDatosItems();

    // Aquí puedes enviar los datos al servidor mediante AJAX o cualquier otra forma
    // Por ejemplo:
    // fetch('/guardar_items', {
    //     method: 'POST',
    //     headers: {
    //         'Content-Type': 'application/json'
    //     },
    //     body: JSON.stringify(datosItems)
    // })
    // .then(response => {
    //     // Manejar la respuesta del servidor
    // })
    // .catch(error => {
    //     console.error('Error al enviar los datos:', error);
    // });

    // O puedes agregar los datos al formulario antes de enviarlo
    const formulario = document.querySelector('form');
    const datosItemsInput = document.createElement('input');
    datosItemsInput.type = 'hidden';
    datosItemsInput.name = 'datos_items';
    datosItemsInput.value = JSON.stringify(datosItems);
    formulario.appendChild(datosItemsInput);

    // Ahora puedes enviar el formulario
    formulario.submit();
}


function updateProductDetails(inputElement, index) {
    const datalist = document.getElementById(inputElement.getAttribute('list'));
    const option = datalist.querySelector(`option[value="${inputElement.value}"]`);
    const productId = option.getAttribute('data-product-id');

    // Actualizar el campo oculto con el ID del producto seleccionado
    const codigoItemInput = document.querySelector(`input[name='items[${index}][codigo_item]']`);
    codigoItemInput.value = productId;

    // Actualizar el precio del producto utilizando una función que deberías tener similar a `fetchProductDetails`
    fetchProductDetails(productId, index);
}



function removeItem(button) {
    button.parentElement.remove();
    updateTotals();
}

function calculateTotal(index) {
    const cantidad = parseFloat(document.querySelector(`input[name='items[${index}][cantidad]']`).value) || 0;
    const precio = parseFloat(document.querySelector(`input[name='items[${index}][precio_unitario]']`).value) || 0;
    const total = cantidad * precio;
    document.querySelector(`input[name='items[${index}][total]']`).value = total.toFixed(2);
    updateTotals();
}

/* function updateTotals() {
    let totalAfecto = 0;
    document.querySelectorAll(`input[name*='[total]']`).forEach(input => {
        totalAfecto += parseFloat(input.value);
    });
    const igv = totalAfecto * 18/118;
    const totalGeneral = totalAfecto - igv;
    document.getElementById('totalAfecto').textContent = totalGeneral.toFixed(2);
    document.getElementById('totalIGV').textContent = igv.toFixed(2);
    document.getElementById('totalGeneral').textContent = totalAfecto.toFixed(2);
} */
function updateTotals() {
    let totalAfecto = 0;
    document.querySelectorAll(`input[name*='[total]']`).forEach(input => {
        totalAfecto += parseFloat(input.value);
    });
    const igv = totalAfecto * 18/118;
    const totalGeneral = totalAfecto - igv;
    document.getElementById('totalAfecto').textContent = totalGeneral.toFixed(2);
    document.getElementById('totalIGV').textContent = igv.toFixed(2);
    document.getElementById('totalGeneral').textContent = totalAfecto.toFixed(2);

    // Actualizar los campos ocultos
    document.getElementById('totalAfectoInput').value = totalGeneral.toFixed(2);
    document.getElementById('totalIGVInput').value = igv.toFixed(2);
    document.getElementById('totalGeneralInput').value = totalAfecto.toFixed(2);
}

function updateRUC(clienteId) {
    // Actualizar el RUC basado en la selección del cliente
    document.getElementById('ruc').value = clienteId; // Simulación, reemplazar con datos reales
}
</script>

</body>
</html>
