<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Comprobante</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .total-summary {
            margin-top: 20px;
        }
        .total-summary td {
            padding: 8px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1>Nuevo Comprobante</h1>
    <form action="{{ url_for('nuevo_comprobante') }}" method="post">
        <div class="mb-3">
            <label for="cliente" class="form-label">Cliente</label>
            <select class="form-select" id="cliente" name="cliente" onchange="updateRUC(this.value)">
                <option selected>Seleccione un Cliente</option>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="ruc" class="form-label">RUC</label>
            <input type="text" class="form-control" id="ruc" name="ruc" readonly>
        </div>
        <div class="mb-3">
            <label for="serie" class="form-label">Código del Comprobante</label>
            <input type="text" class="form-control" id="serie" name="serie" required>
        </div>
        <div class="mb-3">
            <label for="fecha_emision" class="form-label">Fecha de Emisión</label>
            <input type="date" class="form-control" id="fecha_emision" name="fecha_emision" required>
        </div>
        <div id="items">
            <!-- Items will be added here -->
        </div>
        <button type="button" class="btn btn-secondary" onclick="agregarItem()">Agregar Item</button>
        <div class="total-summary">
            <table class="table">
                <tbody>
                    <tr>
                        <td>Total Afecto:</td>
                        <td class="text-end">S/<span id="totalAfecto">0.00</span></td>
                    </tr>
                    <tr>
                        <td>IGV (18%):</td>
                        <td class="text-end">S/<span id="totalIGV">0.00</span></td>
                    </tr>
                    <tr>
                        <td><strong>TOTAL:</strong></td>
                        <td class="text-end"><strong>S/<span id="totalGeneral">0.00</span></strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button type="submit" class="btn btn-primary">Guardar</button>
    </form>
</div>

<script>
let itemIndex = 0;
function agregarItem() {
    const itemsContainer = document.getElementById('items');
    const newItem = document.createElement('div');
    newItem.classList.add('input-group');
    newItem.innerHTML = `
        <input type="number" name="items[${itemIndex}][cantidad]" class="form-control" placeholder="Cantidad" onchange="calculateTotal(${itemIndex})" required>
        <input list="descriptions" name="items[${itemIndex}][descripcion]" class="form-control" placeholder="Descripción" onchange="fetchProductDetails(this.value, ${itemIndex})" required>
        <datalist id="descriptions">
            <!-- Lista de productos desde la base de datos -->
            <option value="Producto 1">
            <option value="Producto 2">
            <option value="Producto 3">
        </datalist>
        <input type="text" name="items[${itemIndex}][precio_unitario]" class="form-control" placeholder="P. Unit." readonly>
        <input type="text" name="items[${itemIndex}][total]" class="form-control" placeholder="Total" readonly>
        <button class="btn btn-danger" type="button" onclick="removeItem(this)">Eliminar</button>
    `;
    itemsContainer.appendChild(newItem);
    itemIndex++;
}

function removeItem(button) {
    button.parentElement.remove();
    updateTotals();
}

function fetchProductDetails(productName, index) {
    // Llamar a la base de datos para obtener los detalles del producto
    // Aquí se debe reemplazar con una llamada real a la base de datos
    document.querySelector(`input[name='items[${index}][precio_unitario]']`).value = 10; // Precio ficticio
    calculateTotal(index);
}

function calculateTotal(index) {
    const cantidad = parseFloat(document.querySelector(`input[name='items[${index}][cantidad]']`).value) || 0;
    const precio = parseFloat(document.querySelector(`input[name='items[${index}][precio_unitario]']`).value) || 0;
    const total = cantidad * precio;
    document.querySelector(`input[name='items[${index}][total]']`).value = total.toFixed(2);
    updateTotals();
}

function updateTotals() {
    let totalAfecto = 0;
    document.querySelectorAll(`input[name*='[total]']`).forEach(input => {
        totalAfecto += parseFloat(input.value);
    });
    const igv = totalAfecto * 18/118;
    const totalGeneral = totalAfecto - igv;
    document.getElementById('totalAfecto').textContent = totalGeneral.toFixed(2);
    document.getElementById('totalIGV').textContent = igv.toFixed(2);
    document.getElementById('totalGeneral').textContent = totalAfecto.toFixed(2);
}

function updateRUC(clienteId) {
    // Actualizar el RUC basado en la selección del cliente
    document.getElementById('ruc').value = 'RUC del cliente ' + clienteId; // Simulación, reemplazar con datos reales
}
</script>

</body>
</html>
